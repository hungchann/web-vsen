name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Build production assets
        run: |
          npm ci
          npm run build

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "."
          target: "/tmp/web-vsen-deploy"
          strip_components: 0
          exclude: |
            node_modules
            .git
            .github
            tests
            storage/logs/*
            .env
            .env.example
            *.md
            docs

      - name: Execute deployment script on VPS
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /var/www/web-vsen
            
            # Backup current version
            sudo cp -r . ../web-vsen-backup-$(date +%Y%m%d_%H%M%S) || true
            
            # Copy new files (preserve .env and storage)
            sudo rsync -av --exclude='.env' --exclude='storage' --exclude='node_modules' \
              /tmp/web-vsen-deploy/ /var/www/web-vsen/
            
            # Install dependencies
            sudo -u www-data composer install --optimize-autoloader --no-dev --no-interaction
            sudo -u www-data npm ci --production=false
            sudo -u www-data npm run build
            
            # Run migrations
            sudo -u www-data php artisan migrate --force
            
            # Optimize Laravel
            sudo -u www-data php artisan config:cache
            sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache
            
            # Restart services
            sudo supervisorctl restart web-vsen-worker:* || true
            sudo systemctl reload php8.2-fpm || true
            
            # Cleanup
            sudo rm -rf /tmp/web-vsen-deploy
            
            echo "âœ… Deployment completed successfully!"
